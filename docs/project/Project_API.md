# Project API Report

## 1. Components and tools used to build API:

* **Main API**: FastAPI module.
* **Mock Server**: Hypercorn server (port 8000).
* **Cache**: a Redis instance (port 6750).
* **Queue**: another Redis instance (port 6835).
* **Database**: MongoDB (port 27017).
* **Testing tools**: Postman, Newman

## 2. API Workflows:

There are 2 features in the API: uploading files and returning results,
hence there are 2 different workflows of those features.

* Workflow of uploading files feature:

![API flow of uploading files](/docs/project/API_Flows/API_upload_file_flow.jpg)

* Workflow of returning results feature:

![API flow of returning results](/docs/project/API_Flows/API_return_results_flow.jpg)

## 3. Test cases for testing API:

### a. Test case of testing uploading files feature:

Uploading files testing was implemented to check whether the API accepted
and enqueued PE32 files for prediction process, or returned an error
message if the file did not satisfy predicting conditions.

For testing this feature, a set of 10 different files was prepared. These
ten files include 8 PE32 files (4 goodwares & 4 malwares), and 2 non-PE32
files.

Here is the test case of uploading files feature (derived from a CSV file):

| fileName | outputMessage |
| :----: | :----: |
| 6884fa613525c3d557cffef160c272b7479656b6d34ef00a527504758274ccaa.bin | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| ccsetup576.exe | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| DriverEasy_Setup.exe | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| ee613018522aad5eeea373ddbebf21f6.exe.vir | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| f350adb34681f8f113c892cda219400090166562ca9c92da59bd8ef39de180b8.bin | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| iobituninstaller.exe | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| Lec 1.srt | Sorry, a PE32 file is expected, but this file is not a PE32 file. |
| Open Before Starting Loader.bin | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| PANDAFREEAV.exe | Your file is successfully uploaded and enqueued. Please wait for a bit. |
| project.xml | Sorry, a PE32 file is expected, but this file is not a PE32 file. |

### b. Test case of testing uploading a PE32 file multiple times:

This is a simple test, and also an extenstion of testing uploading file
feature. To test this, a PE32 file was used to upload to the API multiple
times, in order to test how the API respond to multiple requests of the
same file. Furthermore, this would check whether components, such as
cache memory and the database, are operational or not.

### c. Test case of testing returning results feature:

Returning results testing was implemented to check the prediction results
(right or wrong) comparing to the ground truth of the samples, or returning
error messages (if the file was failed for prediction or ID was invalid).

To test this feature, 12 file IDs were put into testing. The first 10
were from files that were uploaded into the API in the previous test.
The other two are self-generated to indicate two un-uploaded files.

Here is the test case of returning results feature (derived from another
CSV file):

| fileID | expectedPrediction | errorMessage |
| :----: | :----: | :----: |
| 160e7dec4af3bb447093f15c275c04a0 | Malware |  |
| 018c0e87d8722d0afe7f7cd3bf2fc10d | Benign |  |
| 35c95cb6ac767b0403ad7fecf2e0c294 | Benign |  |
| ee613018522aad5eeea373ddbebf21f6 | Malware |  |
| 26e711cc796169f606f84cd3b6510379 | Malware |  |
| b727787fa4f715df94bd2575a4939609 | Benign |  |
| 40d5301b331542b07f969050a8f10653 |  | Sorry, a PE32 file is expected, but this file is not a PE32 file. |
| 451f3bc0ec49995f46b0b0d388b93b95 | Malware |  |
| bc55eb7e07290b1c46c59497a850197e | Benign |  |
| f9290a08822380aadbc35db5c7da213e |  | Sorry, a PE32 file is expected, but this file is not a PE32 file. |
| 839804afa920536dd44abff9035ee74d |  | Sorry, your file ID is invalid. Please upload your file first. |
| 96395aadff820a0375bce820d79ad45e |  | Sorry, your file ID is invalid. Please upload your file first. |

__Note__: the **expectedPrediction** column indicates the ground truth
of each PE32 sample. This could be used for measuring the prediction of
the model when in production.

## 4. API Testing Results:

### a. Testing uploading files feature:

After put the feature of the API (in a Postman collection) into Newman
with the uploading files test case ([3a](#a-test-case-of-testing-uploading-files-feature)),
testing results were retrieved.

![API Uploading Files first 5 samples](/docs/project/API_Test_Results/API_upload_file_sample_1-5.png)

![API Uploading Files last 5 samples](/docs/project/API_Test_Results/API_upload_file_sample_6-10.png)

And here is the overall result of the testing.

![API Uploading Files Overall](/docs/project/API_Test_Results/API_upload_file_overall_result.png)

The results showed that all 10 files were successfully uploaded with no
errors. All PE32 files were successfully enqueued for predictions, and
others resulted in error messages generated and returned.

### b. Testing uploading a PE32 file multiple times:

In this test, a PE32 file was simply uploaded to the API three times.

The response output returned when first time uploaded:

![First time upload file](/docs/project/API_Test_Results/API_file_upload_1.png)

When the file was second time uploaded, the response was:

![Second time upload file](/docs/project/API_Test_Results/API_file_upload_2.png)

And in the third time, the response was:

![Third time upload file](/docs/project/API_Test_Results/API_file_upload_3.png)

The reason for the difference of these responses is when the file was
first uploaded, it was put into queue for prediction process. And in
the second time, the prediction was completed and the result was saved
to the database; and in the third time, the result was cached to cache
memory. As cache memory has higher priority to retrieve result than
database, the result would be still cached even when it was retrieved
from the database.

### c. Testing returning results feature:

And after put returning results feature of the API (which was saved
in another Postman collection) into Newman with the returning result
test case ([3c](#c-test-case-of-testing-returning-results-feature)),
testing results were retrieved.

![API Returning Results first 5 samples](/docs/project/API_Test_Results/API_return_results_sample_1-5.png)

![API Returning Results next 5 samples](/docs/project/API_Test_Results/API_return_results_sample_6-10.png)

![API Returning Results last 2 samples](/docs/project/API_Test_Results/API_return_results_sample_11-12.png)

And here is the overall result of the test.

![API Returning Results overall](/docs/project/API_Test_Results/API_return_results_overall_result.png)

The results of 12 ID showed that there were 3 of them that had wrong
result. Details of the fault of those three are listed below.

![API Returning Results error details](/docs/project/API_Test_Results/API_return_results_errors_info.png)

This indicates that all 3 wrongly predicted samples have **Malware**
as their ground truth, but were predicted as **Benign**. That means
3 of 4 malwares prepared for testing were mis-detected. That is quite
problematic.

## 5. Limitations and future improvements:

### a. Limitations:

Although the recall score of the model is quite high (just under 95%),
the model still mis-detect malware files (in production, 3 of 4 malwares
were mis-detected).

### b. Future improvements:

As the data used for training the model was quite imbalanced, getting
more malware samples is necessary for future re-training. Moreover,
getting the dataset more balanced may improve accuracy of detecting
malwares and minimize ratio of malware mis-detection.
