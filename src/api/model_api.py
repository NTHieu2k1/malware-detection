from fastapi import FastAPI, File, UploadFile
from src.models.model_file_io import ModelFileIO
import pefile
from hashlib import md5

malware_detector = FastAPI()


@malware_detector.get('/')
async def root():
    return {'intro': 'This is a malware detector application.'}


def validate_pe_sample(file_content: bytes) -> bool:
    # Check whether a sample is a PE32 sample or not
    try:
        pe_info = pefile.PE(data=file_content)
        if pe_info.OPTIONAL_HEADER.Magic != 267:
            return False
        return True
    except pefile.PEFormatError:
        return False


def get_md5_hash_value(file_content: bytes):
    md5_getter = md5()
    md5_getter.update(file_content)
    return md5_getter.hexdigest()


def get_prediction_results(models: list, file_content: bytes) -> dict:
    prediction_results = dict()
    version = 0
    for model in models:
        version += 1
        predictions = model.predict_a_sample(file_content)
        prediction_results.update({'Model v'+str(version): predictions})
    return prediction_results


def format_output(file_name, md5_hash, predictions) -> dict:
    output = {
        'File': file_name,
        'MD5': md5_hash,
        'Predictions': predictions
    }
    return output


@malware_detector.post('/samples/')
async def upload_n_predict(file: UploadFile = File(...)):
    # Get file content
    file_content = file.file.read()
    # Validate the sample: show error message if the sample file is not PE32 file
    if not validate_pe_sample(file_content):
        return {'msg': 'Sorry, a PE32 file is expected, but this file is not a PE32 file.'}
    # Get file name and MD5 hash value
    file_name = file.filename
    md5_value = get_md5_hash_value(file_content)
    # Load trained models
    model_io = ModelFileIO()
    models = model_io.load_models()
    # Use models to predict the sample
    try:
        prediction_results = get_prediction_results(models, file_content)
    # Show error message if missing values encountered in the sample
    except ValueError:
        return {'msg': 'Sorry, there are some missing values in the file.'}
    return format_output(file_name, md5_value, prediction_results)
