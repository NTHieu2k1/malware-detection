from pathlib import Path
from abc import ABC, abstractmethod
from pefile import PE
from src.utilities.file import get_project_root_directory
import os


class Filter(ABC):
    @abstractmethod
    def get_raw_data_directory(self):
        pass

    @abstractmethod
    def filter_non_pe_files(self):
        pass


class BenignFilter(Filter):
    def __init__(self):
        self.inner_benign_dir = 'data/raw/benign'
        self._full_raw_benign_dir = ''
        self.filtered_benign_path_info = get_project_root_directory() / Path('data/raw/filtered_benign_list.txt')

    @property
    def full_raw_benign_dir(self):
        return self._full_raw_benign_dir

    @full_raw_benign_dir.setter
    def full_raw_benign_dir(self, new_dir_value):
        self._full_raw_benign_dir = new_dir_value

    def get_raw_data_directory(self):
        project_root_directory = get_project_root_directory()
        self.full_raw_benign_dir = project_root_directory / Path(self.inner_benign_dir)

    def filter_non_pe_files(self):
        # Get the list of all data file paths
        all_file_paths = list(Path(self.full_raw_benign_dir).glob('**/*'))[20:]
        # Filter benign files that are PE files (which can be read by PE reader)
        index = 0
        no_of_paths = len(all_file_paths)
        filter_benign = open(self.filtered_benign_path_info, 'w')
        for file_path in all_file_paths:
            try:
                pe_info = PE(file_path)
                # Skip files which are not PE32 files
                if pe_info.OPTIONAL_HEADER.Magic != 267:
                    continue
                filter_benign.write(str(file_path) + '\n')
            # If read error occurred, skip the file
            except:
                continue
            os.system('clear')
            print('(Benign) Filtering progress: %.2f%%' % ((index/no_of_paths)*100))
            index += 1
        filter_benign.close()


class MalwareFilter(Filter):
    def __init__(self):
        self.inner_malware_dir = 'data/raw/malware'
        self._full_malware_dir = Path()
        self.filtered_malware_path_info = get_project_root_directory() / Path('data/raw/filtered_malware_list.txt')

    @property
    def full_malware_dir(self):
        return self._full_malware_dir

    @full_malware_dir.setter
    def full_malware_dir(self, updated_dir):
        self._full_malware_dir = updated_dir

    def get_raw_data_directory(self):
        self.full_malware_dir = get_project_root_directory() / Path(self.inner_malware_dir)

    def filter_non_pe_files(self):
        # Get list of all malware file paths
        all_file_paths = list(self.full_malware_dir.glob('*'))
        index = 0
        no_of_paths = len(all_file_paths)
        # Filter malware files that are PE files (which can be read by PE reader)
        filter_malware = open(self.filtered_malware_path_info, 'w')
        for file_path in all_file_paths:
            try:
                pe_info = PE(file_path)
                # Skip files which are not PE32 files
                if pe_info.OPTIONAL_HEADER.Magic != 267:
                    continue
                filter_malware.write(str(file_path) + '\n')
            # If read error occurred, skip that file
            except:
                continue
            os.system('clear')
            print('(Malware) Filtering progress: %.2f%%' % ((index/no_of_paths)*100))
            index += 1
        filter_malware.close()
